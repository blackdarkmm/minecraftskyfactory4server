name: Fabric Server - 雲端世界備份 (ZeroTier VPN)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [fabric-server-cloud-backup-zerotier-vpn]

jobs:
  minecraft:
    runs-on: ubuntu-latest

    env:
      RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
      RCON_PORT: ${{ secrets.RCON_PORT }}

    steps:
      - name: 檢出 repo 檔案
        uses: actions/checkout@v4

      - name: 設定 server.properties（RCON）
        run: |
          grep -q "^rcon.password=" server.properties \
            && sed -i "s|^rcon.password=.*|rcon.password=${RCON_PASSWORD}|" server.properties \
            || echo "rcon.password=${RCON_PASSWORD}" >> server.properties

          grep -q "^rcon.port=" server.properties \
            && sed -i "s|^rcon.port=.*|rcon.port=${RCON_PORT}|" server.properties \
            || echo "rcon.port=${RCON_PORT}" >> server.properties

      - name: 安裝 Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: 安裝必要工具
        run: |
          sudo apt update
          sudo apt install -y unzip screen python3-pip
          pip install gdown

      - name: 下載 world.zip（Google Drive）
        env:
          FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}
        run: |
          gdown --id $FILE_ID -O world.zip

      - name: 解壓世界檔案
        run: |
          rm -rf world
          unzip -o world.zip

      - name: 安裝 ZeroTier
        run: curl -s https://install.zerotier.com | sudo bash

      - name: 匯入 ZeroTier identity
        run: |
          sudo systemctl stop zerotier-one
          echo "${{ secrets.ZT_IDENTITY_SECRET }}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret
          sudo systemctl start zerotier-one

      - name: 加入 ZeroTier 網路
        env:
          ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
        run: |
          sudo zerotier-cli join $ZT_NETWORK_ID
          sleep 10
          sudo zerotier-cli listnetworks

      - name: 啟動 Fabric Server
        run: |
          screen -L -dmS minecraft java -Xmx6G -Xms6G -jar fabric-server-launch.jar nogui

      - name: 伺服器運行中（最多 5 小時）
        run: |
          start_time=$(date +%s)
          timeout=$((5 * 60 * 60))

          while screen -list | grep -q "minecraft"; do
            now=$(date +%s)
            if [ $((now - start_time)) -ge $timeout ]; then
              echo "達到 5 小時，準備關機"
              break
            fi
            sleep 10
          done

      - name: 優雅關閉伺服器
        run: |
          if screen -list | grep -q "minecraft"; then
            screen -S minecraft -p 0 -X stuff "save-all flush$(printf \\r)"
            screen -S minecraft -p 0 -X stuff "stop$(printf \\r)"
            sleep 15
          fi

      - name: 壓縮世界
        run: zip -r world.zip world

      - name: 安裝 rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: 寫入 rclone 設定
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: 上傳 world.zip 到 Google Drive
        run: |
          rclone copy world.zip gdrive:minecraft_world \
            --drive-chunk-size 64M \
            --transfers=4 \
            --retries=10 \
            --progress
