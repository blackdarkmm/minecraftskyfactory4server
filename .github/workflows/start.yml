name: Forge Server - é›²ç«¯ä¸–ç•Œå‚™ä»½ (ZeroTier VPN)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [fabric-server-cloud-backup-zerotier-vpn]

jobs:
  minecraft:
    runs-on: ubuntu-latest

    env:
      ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
      ZT_IDENTITY_SECRET: ${{ secrets.ZT_IDENTITY_SECRET }}

    steps:
      - name: æª¢å‡º repo æª”æ¡ˆ
        uses: actions/checkout@v4

      - name: å®‰è£ Java 20
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 20

      - name: å®‰è£ Python å’Œ gdown
        run: |
          sudo apt update
          sudo apt install python3-pip unzip -y
          pip install gdown

      - name: å®‰è£ screen
        run: sudo apt-get install -y screen

      - name: ä¸‹è¼‰ world.zipï¼ˆå¾ž Google Driveï¼‰
        env:
          FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}
        run: |
          echo "å¾ž Google Drive ä¸‹è¼‰ world.zip..."
          gdown --id $FILE_ID -O world.zip

      - name: è§£å£“ç¸®ä¸–ç•Œæª”æ¡ˆï¼ˆå¦‚æœ‰ï¼‰
        run: |
          if [ -f world.zip ]; then
            echo "Found world.zip, attempting unzip..."
            unzip world.zip
          else
            echo "No world.zip found, skipping unzip."
          fi

      - name: å®‰è£ ZeroTier CLI
        run: |
          curl -s https://install.zerotier.com | sudo bash

      - name: åŒ¯å…¥ ZeroTier èº«ä»½æª”æ¡ˆï¼ˆä¿è­‰å›ºå®š IPï¼‰
        run: |
          sudo systemctl stop zerotier-one || true
          echo "${ZT_IDENTITY_SECRET}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret
          sudo systemctl start zerotier-one

          echo "ç­‰å¾… identity.public ç”Ÿæˆ..."
          for i in {1..10}; do
            if [ -f /var/lib/zerotier-one/identity.public ]; then
              echo "âœ… identity.public å·²ç”Ÿæˆ"
              break
            fi
            sleep 1
          done
          echo "ç›®å‰èº«ä»½ï¼š"
          sudo cat /var/lib/zerotier-one/identity.public || echo "âš ï¸ ç„¡æ³•è®€å–èº«ä»½"

      - name: åŠ å…¥ ZeroTier ç¶²è·¯
        run: |
          echo "âœ… ç­‰å¾… ZeroTier æœå‹™å•Ÿå‹•..."
          for i in {1..10}; do
            if sudo zerotier-cli info &>/dev/null; then
              echo "âœ… ZeroTier æœå‹™å·²å•Ÿå‹•"
              break
            fi
            sleep 2
          done

          echo "ðŸš€ å˜—è©¦åŠ å…¥ ZeroTier ç¶²è·¯ï¼š$ZT_NETWORK_ID"
          sudo zerotier-cli join $ZT_NETWORK_ID

          echo "ðŸ•“ ç­‰å¾… ZeroTier æˆåŠŸé€£ç·š..."
          for i in {1..20}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep $ZT_NETWORK_ID | awk '{print $5}')
            echo "ç›®å‰ç‹€æ…‹ï¼š$STATUS"
            if [[ "$STATUS" == "OK" ]]; then
              echo "âœ… å·²æˆåŠŸåŠ å…¥ ZeroTier ç¶²è·¯"
              break
            fi
            sleep 3
          done

      - name: é¡¯ç¤º ZeroTier IP
        run: sudo zerotier-cli listnetworks

      - name: å•Ÿå‹• Fabric Serverï¼ˆä½¿ç”¨ screenï¼‰
        run: |
          screen -L -dmS minecraft java -Xmx6G -Xms6G -jar forge-1.12.2-14.23.5.2860.jar nogui

      # ä¼ºæœå™¨é‹è¡Œã€å‚™ä»½ã€å£“ç¸®ã€ä¸Šå‚³æ­¥é©Ÿä¿æŒä¸è®Š
      - name: å£“ç¸®ä¸–ç•Œ
        run: zip -r world.zip world

      - name: å®‰è£ rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: å¯«å…¥ rclone è¨­å®šæª”ï¼ˆbase64ï¼‰
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: ä¸Šå‚³ world.zip åˆ° Google Drive
        run: |
          rclone -vv copy world.zip gdrive:SkyFactory4World \
            --drive-chunk-size 64M \
            --transfers=4 \
            --retries=10 \
            --low-level-retries=20 \
            --progress

      - name: è§¸ç™¼ä¸‹ä¸€æ¬¡åŸ·è¡Œ
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: fabric-server-cloud-backup-zerotier-vpn
