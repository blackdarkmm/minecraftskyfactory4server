name: Fabric Server - é›²ç«¯ä¸–ç•Œå‚™ä»½ (ZeroTier VPN)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [fabric-server-cloud-backup-zerotier-vpn]

jobs:
  minecraft:
    runs-on: ubuntu-latest

    env:
      RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
      RCON_PORT: ${{ secrets.RCON_PORT }}

    steps:
      - name: æª¢å‡º repo æª”æ¡ˆ
        uses: actions/checkout@v4

      - name: è¨­å®š server.propertiesï¼ˆRCONï¼‰
        run: |
          grep -q "^rcon.password=" server.properties \
            && sed -i "s|^rcon.password=.*|rcon.password=${RCON_PASSWORD}|" server.properties \
            || echo "rcon.password=${RCON_PASSWORD}" >> server.properties

          grep -q "^rcon.port=" server.properties \
            && sed -i "s|^rcon.port=.*|rcon.port=${RCON_PORT}|" server.properties \
            || echo "rcon.port=${RCON_PORT}" >> server.properties

      - name: å®‰è£ Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: å®‰è£å¿…è¦å·¥å…·
        run: |
          sudo apt update
          sudo apt install -y unzip screen python3-pip
          pip install gdown

      - name: ä¸‹è¼‰ world.zipï¼ˆGoogle Driveï¼‰
        env:
          FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}
        run: |
          gdown --id $FILE_ID -O world.zip

      - name: è§£å£“ä¸–ç•Œæª”æ¡ˆ
        run: |
          rm -rf world
          unzip -o world.zip

      - name: å®‰è£ ZeroTier
        run: curl -s https://install.zerotier.com | sudo bash

      - name: åŒ¯å…¥ ZeroTier identity
        run: |
          sudo systemctl stop zerotier-one
          echo "${{ secrets.ZT_IDENTITY_SECRET }}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret
          sudo systemctl start zerotier-one

      - name: åŠ å…¥ ZeroTier ç¶²è·¯ï¼ˆç­‰å¾… daemon å°±ç·’ï¼‰
        env:
          ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
        run: |
          echo "â³ ç­‰å¾… ZeroTier daemon å•Ÿå‹•..."

          for i in {1..20}; do
            if sudo zerotier-cli info >/dev/null 2>&1; then
              echo "âœ… ZeroTier daemon å·²å°±ç·’"
              break
            fi
            echo "å°šæœªå°±ç·’ï¼Œç­‰å¾…ä¸­... ($i/50)"
            sleep 2
          done

          echo "ðŸš€ å˜—è©¦åŠ å…¥ç¶²è·¯ $ZT_NETWORK_ID"
          sudo zerotier-cli join "$ZT_NETWORK_ID"

          echo "â³ ç­‰å¾…ç¶²è·¯ç‹€æ…‹ OK..."
          for i in {1..50}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep "$ZT_NETWORK_ID" | awk '{print $5}')
            echo "ç›®å‰ç‹€æ…‹ï¼š$STATUS"
            if [ "$STATUS" = "OK" ]; then
              echo "âœ… å·²æˆåŠŸåŠ å…¥ ZeroTier ç¶²è·¯"
              exit 0
            fi
            sleep 3
          done

          echo "âŒ åŠ å…¥ ZeroTier ç¶²è·¯å¤±æ•—"
          sudo zerotier-cli listnetworks
          exit 1

      - name: å•Ÿå‹• Fabric Server
        run: |
          screen -L -dmS minecraft java -Xmx6G -Xms6G -jar fabric-server-launch.jar nogui

      - name: ä¼ºæœå™¨é‹è¡Œä¸­ï¼ˆæœ€å¤š 5 å°æ™‚ï¼‰
        run: |
          start_time=$(date +%s)
          timeout=$((5 * 60 * 60))

          while screen -list | grep -q "minecraft"; do
            now=$(date +%s)
            if [ $((now - start_time)) -ge $timeout ]; then
              echo "é”åˆ° 5 å°æ™‚ï¼Œæº–å‚™é—œæ©Ÿ"
              break
            fi
            sleep 10
          done

      - name: å„ªé›…é—œé–‰ä¼ºæœå™¨
        run: |
          if screen -list | grep -q "minecraft"; then
            screen -S minecraft -p 0 -X stuff "save-all flush$(printf \\r)"
            screen -S minecraft -p 0 -X stuff "stop$(printf \\r)"
            sleep 15
          fi

      - name: å£“ç¸®ä¸–ç•Œ
        run: zip -r world.zip world

      - name: å®‰è£ rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: å¯«å…¥ rclone è¨­å®š
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: ä¸Šå‚³ world.zip åˆ° Google Drive
        run: |
          rclone copy world.zip gdrive:minecraft_world \
            --drive-chunk-size 64M \
            --transfers=4 \
            --retries=10 \
            --progress
