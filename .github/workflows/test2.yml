name: ZeroTier Test

on:
  workflow_dispatch:

jobs:
  zerotier-test:
    runs-on: ubuntu-latest

    env:
      ZT_IDENTITY_SECRET: ${{ secrets.ZT_IDENTITY_SECRET }}
      ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}

    steps:
      - name: 安裝 ZeroTier CLI
        run: |
          curl -f -s https://install.zerotier.com -o install.sh
          chmod +x install.sh
          sudo ./install.sh

      - name: 匯入身份檔案
        run: |
          sudo systemctl stop zerotier-one || true
          echo "$ZT_IDENTITY_SECRET" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret

      - name: 手動啟動 ZeroTier daemon
        run: |
          sudo /usr/sbin/zerotier-one -d /var/lib/zerotier-one &
          sleep 5

      - name: 檢查 ZeroTier 身份與狀態
        run: |
          sudo zerotier-cli info
          sudo zerotier-cli listnetworks
