name: ZeroTier 測試

on:
  workflow_dispatch:

jobs:
  zerotier-test:
    runs-on: ubuntu-latest

    env:
      ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
      ZT_IDENTITY_SECRET: ${{ secrets.ZT_IDENTITY_SECRET }}

    steps:
      - name: 檢出 repo
        uses: actions/checkout@v4

      - name: 安裝 ZeroTier CLI
        run: |
          for i in {1..5}; do
            echo "Attempt $i to install ZeroTier"
            curl -f -s https://install.zerotier.com -o install.sh && break
            echo "Retrying in 5 seconds..."
            sleep 5
          done
          if [ ! -f install.sh ]; then
            echo "❌ Failed to download install script"
            exit 1
          fi
          chmod +x install.sh
          sudo ./install.sh

      - name: 匯入 ZeroTier 身份
        run: |
          sudo systemctl stop zerotier-one
          echo "${ZT_IDENTITY_SECRET}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret
          sudo systemctl start zerotier-one

      - name: 加入 ZeroTier 網路
        run: |
          for i in {1..30}; do
            if sudo zerotier-cli info &>/dev/null; then
              echo "ZeroTier 已啟動"
              break
            fi
            echo "等待 ZeroTier 啟動... ($i/30)"
            sleep 2
          done

          sudo zerotier-cli join $ZT_NETWORK_ID || {
            echo "❌ 加入 ZeroTier 網路失敗"
            exit 1
          }

          echo "等待 ZeroTier 成功連線..."
          for i in {1..20}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep $ZT_NETWORK_ID | awk '{print $5}')
            echo "目前狀態：$STATUS"
            if [[ "$STATUS" == "OK" ]]; then
              echo "✅ 已加入 ZeroTier 網路"
              break
            fi
            sleep 3
          done

      - name: 測試 ZeroTier
        run: |
          echo "ZeroTier 網路狀態："
          sudo zerotier-cli listnetworks
          echo "9993 UDP 端口狀態："
          sudo ss -nuap | grep 9993 || echo "端口 9993 尚未開啟"
