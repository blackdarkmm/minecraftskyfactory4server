name: Test ZeroTier

on:
  workflow_dispatch:

jobs:
  zerotier-test:
    runs-on: ubuntu-latest
    env:
      ZT_IDENTITY_SECRET: ${{ secrets.ZT_IDENTITY_SECRET }}
      ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}

    steps:
      - name: 安裝 ZeroTier CLI
        run: |
          for i in {1..5}; do
            echo "Attempt $i to install ZeroTier"
            curl -f -s https://install.zerotier.com -o install.sh && break
            echo "Retrying in 5 seconds..."
            sleep 5
          done

          if [ ! -f install.sh ]; then
            echo "❌ Failed to download install script from install.zerotier.com"
            exit 1
          fi

          chmod +x install.sh
          sudo ./install.sh

      - name: 匯入 ZeroTier 身份檔案
        run: |
          echo "${{ secrets.ZT_IDENTITY_SECRET }}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret

      - name: 加入 ZeroTier 網路
        env:
          ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
        run: |
          echo "嘗試加入 ZeroTier 網路：$ZT_NETWORK_ID"
          sudo zerotier-cli join $ZT_NETWORK_ID
          sleep 5
          for i in {1..20}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep $ZT_NETWORK_ID | awk '{print $5}')
            echo "目前狀態：$STATUS"
            if [[ "$STATUS" == "OK" ]]; then
              echo "✅ 已成功加入 ZeroTier 網路"
              break
            fi
            sleep 3
          done
